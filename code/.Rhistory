## make appendix Fig 1: excess death rate and covid-to-excess ratio by BEA region and metro
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
source("prelim_plot.R")
## load data ----
dat_xc_county <- read_rds(file = "../final_data/fitted_and_actual_deaths_county_sets_2020_W2020_wash_6_3_countyrow.rds")
dat_xc_county <- dat_xc_county %>%
group_by(state, cs_name) %>%
mutate(metroname_mode = Mode(metroname))
dat_xc_countyset <- dat_xc_county %>%
distinct(state, cs_name, .keep_all = TRUE) %>%
select(-county_code, -county_fips, -county_name, -metroname)
## exclude counties with negative excess mortality
dat_xc_countyset <- dat_xc_countyset %>%
filter(excess_deaths_2020 > 0)
vdat <- dat_xc_countyset %>%
group_by(region_bea, metroname_mode) %>%
summarise(across(
c(
"covid_deaths_2020", "fitted_deaths_2020",
"all_cause_deaths_2020", "cens_pop_est"
),
~ sum(.x, na.rm = TRUE)
)) %>%
ungroup() %>%
mutate(
offset = cens_pop_est / 100000,
excess_deaths_2020 = all_cause_deaths_2020 - fitted_deaths_2020,
excess_death_rate = excess_deaths_2020 / offset,
covid_excess_ratio = covid_deaths_2020 / excess_deaths_2020,
region_bea = factor(
region_bea,
levels = c(
"Mideast", "Great Lakes", "New England", "Plains",
"Southeast", "Southwest", "Far West", "Rocky Mountain"
)
)
)
vdat_long <- vdat %>%
transmute(region_bea, metroname_mode, excess_death_rate, covid_excess_ratio = covid_excess_ratio * 100) %>%
gather(var, val, -region_bea, -metroname_mode)
vdat_long <- vdat_long %>%
mutate(
mean = case_when(
var == "excess_death_rate" ~ 135,
var == "covid_excess_ratio" ~ 86.7
),
label = case_when(
var == "excess_death_rate" ~ "Weighted mean = 135",
var == "covid_excess_ratio" ~ "Weighted mean = 87"
),
ypos = case_when(
var == "excess_death_rate" ~ 194,
var == "covid_excess_ratio" ~ 113
),
var = case_when(
var == "excess_death_rate" ~ "Excess deaths (Per 100,000 Person-Years)",
var == "covid_excess_ratio" ~ "Ratio of COVID-19 deaths to excess deaths (%)"
),
var = factor(
var,
levels = c(
"Excess deaths (Per 100,000 Person-Years)",
"Ratio of COVID-19 deaths to excess deaths (%)"
)
)
)
vdat_long <- vdat_long %>%
group_by(var) %>%
mutate(
n = row_number(),
label = ifelse(n == 1, label, NA)
)
ggplot(vdat_long) +
geom_bar(aes(
x = region_bea, y = val,
fill = metroname_mode, group = metroname_mode
),
stat = "identity",
position = "dodge"
) +
geom_text(aes(
x = region_bea, y = val,
label = as.integer(val), color = metroname_mode
),
position = position_dodge(width = 0.9),
hjust = 1.2,
size = 2.7
) +
labs(
title = "", x = "BEA Region",
y = ""
) +
facet_wrap(~var, scales = "free_x") +
scale_x_discrete(limits = rev) +
scale_color_manual(values = c("white", "white", "white", "black")) +
scale_fill_manual(
name = "Metro:",
labels = c("Lg central metro", "Lg fringe metro", "Md/Sm metro", "Nonmetro"),
values = rev(blue_palette4)
) +
geom_hline(aes(yintercept = mean), linetype = "dashed") +
geom_text(
size = 3,
x = "Far West",
aes(label = label, y = ypos)
) +
coord_flip() +
theme_minimal() +
theme(
legend.position = "bottom",
legend.title = element_blank(),
strip.text = element_text(size = 11)
) +
guides(color = "none")
ggsave(filename = paste0(outpath, "afig1_excess_regionmetro_bar.png"), width = 8, height = 7)
## make appendix figure A2 and A3: time series plots
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
source("prelim_plot.R")
# load data
dat_xc <- read_csv(paste0(datapath, "fitted_and_actual_deaths_county_sets_2020_W2020_wash_6_3.csv"))
dat_pan <- read_csv(paste0(datapath, "fitted_and_actual_deaths_county_sets_2011_2020_W2020_wash_6_3.csv"))
bea <- read_rds("../raw_data/state_bearegion_crosswalk.rds")
bea <- bea %>%
transmute(
state = state_abb,
region_bea, region_group_bea
)
dat_xc <- left_join(
dat_xc, bea,
by = "state"
)
# select 4 most populous counties from each BEA region
selected_counties <- dat_xc %>%
group_by(region_bea) %>%
slice_max(order_by = cens_pop_est, n = 4)
plot_df <- dat_pan %>%
transmute(
cs_name, state, year,
total_death_rate, fitted_death_rate,
pred_death_rate_lwr_ci, pred_death_rate_upr_ci
) %>%
right_join(
.,
selected_counties %>%
transmute(cs_name, state, region_bea, cens_pop_est, covid_death_rate_2020),
by = c("cs_name", "state")
) %>%
mutate_at(
vars(matches("rate")),
~ . * 100
) %>%
mutate(
predicted_and_covid = fitted_death_rate + covid_death_rate_2020,
cs_name = paste0(cs_name, " County, ", state),
cs_name = ifelse(cs_name == "New York (county) County, NY", "New York County, NY", ifelse(
cs_name == "St. Louis (county) County, MO", "St. Louis County, MO", cs_name
))
)
plot_df_long <- plot_df %>%
select(
region_bea, cs_name, year, total_death_rate, fitted_death_rate,
pred_death_rate_lwr_ci, pred_death_rate_upr_ci, predicted_and_covid
) %>%
gather(
variable, value, -region_bea, -cs_name, -year,
-pred_death_rate_lwr_ci, -pred_death_rate_upr_ci
) %>%
arrange(region_bea, cs_name) %>%
mutate_at(
vars(pred_death_rate_lwr_ci, pred_death_rate_upr_ci),
~ ifelse(variable == "total_death_rate", NA, .)
) %>%
mutate(
value = ifelse(variable == "predicted_and_covid" & year != 2020, NA, value),
variable = case_when(
variable == "total_death_rate" ~ "Observed death rate",
variable == "fitted_death_rate" ~ "Expected death rate",
variable == "predicted_and_covid" ~ "Expected + COVID-19 death rate"
),
variable = factor(variable,
levels = c("Observed death rate", "Expected death rate", "Expected + COVID-19 death rate")
)
)
plot_ts_cd <- function(region_bea_name = NA) {
ggplot(
plot_df_long %>% filter(region_bea == region_bea_name),
aes(x = year, y = value, color = variable)
) +
geom_line() +
geom_point(aes(shape = variable), size = 1.5) +
geom_ribbon(
aes(ymin = pred_death_rate_lwr_ci, ymax = pred_death_rate_upr_ci),
alpha = 0.3, fill = blue_palette[1], linetype = 0
) +
scale_shape_manual(
values = c(16, 17, 8)
) +
scale_color_manual(values = c("#08519C", "#6BAED6", "#fec44f")) +
scale_x_continuous(breaks = seq(2011, 2020, 3)) +
facet_wrap(cs_name ~ ., scales = "free", ncol = 4) +
plot_theme() +
labs(
x = "", y = "",
title = region_bea_name
) +
theme(
axis.text = element_text(size = 8),
strip.text = element_text(size = 9),
plot.title = element_text(size = 10, hjust = 0.5),
panel.grid.minor = element_line(size = 0.05),
panel.grid.major = element_line(size = 0.25),
plot.margin = margin(0, 5, 0, 0, "mm"),
aspect.ratio = 9 / 16
)
}
region_bea_name <- c(
"New England", "Mideast", "Great Lakes", "Plains",
"Rocky Mountain", "Far West", "Southeast", "Southwest"
)
plot_out <- list()
for (i in 1:10) {
plot_out[[i]] <- plot_ts_cd(region_bea_name[i])
}
ts_plot1 <- ggarrange(
plot_out[[1]], plot_out[[2]], plot_out[[3]], plot_out[[4]],
common.legend = TRUE, legend = "bottom", nrow = 4
)
annotate_figure(ts_plot1,
left = text_grob("Deaths (Per 100,000 Person-Years)", rot = 90)
)
ggsave(paste0(outpath, "afig_time_series_stacked1.png"), width = 8.5, height = 11)
ts_plot2 <- ggarrange(
plot_out[[5]], plot_out[[6]], plot_out[[7]], plot_out[[8]],
common.legend = TRUE, legend = "bottom", nrow = 4
)
annotate_figure(ts_plot2,
left = text_grob("Deaths (Per 100,000 Person-Years)", rot = 90)
)
ggsave(paste0(outpath, "afig_time_series_stacked2.png"), width = 8.5, height = 11)
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
source("prelim_plot.R")
dat_xc <- read_csv(paste0(datapath, "fitted_and_actual_deaths_county_sets_2020_W2020_wash_6_3.csv"))
?cut
seq(0, 100, 5)
covid_excess_ratio <- dat_xc %>%
transmute(
county = cs_name, cens_pop_est,
covid_excess_death_ratio = (covid_deaths_2020 / excess_deaths_2020) * 100,
covid_excess_death_ratio = ifelse(
excess_deaths_2020 < 0, 0, ifelse(
covid_excess_death_ratio > 100, 100, covid_excess_death_ratio
)
),
a = cut(covid_excess_death_ratio, breaks = seq(0, 100, 5), include.lowest = TRUE)
# covid_excess_death_ratio_cat = case_when(
#   covid_excess_death_ratio >= 0 & covid_excess_death_ratio <= 10 ~ "[0,10]",
#   covid_excess_death_ratio > 10 & covid_excess_death_ratio <= 20 ~ "(10,20]",
#   covid_excess_death_ratio > 20 & covid_excess_death_ratio <= 30 ~ "(20,30]",
#   covid_excess_death_ratio > 30 & covid_excess_death_ratio <= 40 ~ "(30,40]",
#   covid_excess_death_ratio > 40 & covid_excess_death_ratio <= 50 ~ "(40,50]",
#   covid_excess_death_ratio > 50 & covid_excess_death_ratio <= 60 ~ "(50,60]",
#   covid_excess_death_ratio > 60 & covid_excess_death_ratio <= 70 ~ "(60,70]",
#   covid_excess_death_ratio > 70 & covid_excess_death_ratio <= 80 ~ "(70,80]",
#   covid_excess_death_ratio > 80 & covid_excess_death_ratio <= 90 ~ "(80,90]",
#   covid_excess_death_ratio > 90 & covid_excess_death_ratio <= 100 ~ "(90,100]"
# )
)
View(covid_excess_ratio)
summary(covid_excess_ratio$a)
covid_excess_ratio <- dat_xc %>%
transmute(
county = cs_name, cens_pop_est,
covid_excess_death_ratio = (covid_deaths_2020 / excess_deaths_2020) * 100,
covid_excess_death_ratio = ifelse(
excess_deaths_2020 < 0, 0, ifelse(
covid_excess_death_ratio > 100, 100, covid_excess_death_ratio
)
),
covid_excess_death_ratio_cat = cut(covid_excess_death_ratio, breaks = seq(0, 100, 5), include.lowest = TRUE)
# covid_excess_death_ratio_cat = case_when(
#   covid_excess_death_ratio >= 0 & covid_excess_death_ratio <= 10 ~ "[0,10]",
#   covid_excess_death_ratio > 10 & covid_excess_death_ratio <= 20 ~ "(10,20]",
#   covid_excess_death_ratio > 20 & covid_excess_death_ratio <= 30 ~ "(20,30]",
#   covid_excess_death_ratio > 30 & covid_excess_death_ratio <= 40 ~ "(30,40]",
#   covid_excess_death_ratio > 40 & covid_excess_death_ratio <= 50 ~ "(40,50]",
#   covid_excess_death_ratio > 50 & covid_excess_death_ratio <= 60 ~ "(50,60]",
#   covid_excess_death_ratio > 60 & covid_excess_death_ratio <= 70 ~ "(60,70]",
#   covid_excess_death_ratio > 70 & covid_excess_death_ratio <= 80 ~ "(70,80]",
#   covid_excess_death_ratio > 80 & covid_excess_death_ratio <= 90 ~ "(80,90]",
#   covid_excess_death_ratio > 90 & covid_excess_death_ratio <= 100 ~ "(90,100]"
# )
)
covid_excess_ratio_cum <- covid_excess_ratio %>%
group_by(covid_excess_death_ratio_cat) %>%
summarise(
n = n(),
pop = sum(cens_pop_est)
) %>%
# mutate(
#   covid_excess_death_ratio_cat = factor(
#     covid_excess_death_ratio_cat,
#     levels = c(
#       "[0,10]", "(10,20]", "(20,30]", "(30,40]", "(40,50]", "(50,60]",
#       "(60,70]", "(70,80]", "(80,90]", "(90,100]"
#     )
#   )
# ) %>%
arrange(covid_excess_death_ratio_cat) %>%
mutate(cum_pop = cumsum(pop))
View(covid_excess_ratio_cum)
kt <- kbl(covid_excess_ratio_cum, "latex",
booktabs = T, linesep = "",
col.names = c(
"Percent of excess deaths \n assigned to COVID-19",
"Number of county sets",
"Population",
"Cumulative population"
),
format.args = list(big.mark = ","),
row.names = TRUE
)
View(covid_excess_ratio)
covid_excess_ratio <- covid_excess_ratio %>% arrange(covid_excess_death_ratio)
dat_xc <- dat_xc %>% arrange(covid_deaths_2020)
View(dat_xc)
## make appendix tab A2: cumulative pop in diff levels of excess death assignmnent to COVID-19
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
source("prelim_plot.R")
dat_xc <- read_csv(paste0(datapath, "fitted_and_actual_deaths_county_sets_2020_W2020_wash_6_3.csv"))
covid_excess_ratio <- dat_xc %>%
transmute(
county = cs_name, cens_pop_est,
covid_excess_death_ratio = (covid_deaths_2020 / excess_deaths_2020) * 100,
covid_excess_death_ratio = ifelse(
excess_deaths_2020 < 0, 0, ifelse(
covid_excess_death_ratio > 100, 100, covid_excess_death_ratio
)
),
covid_excess_death_ratio_cat = cut(covid_excess_death_ratio, breaks = seq(0, 100, 5), include.lowest = TRUE)
# covid_excess_death_ratio_cat = case_when(
#   covid_excess_death_ratio >= 0 & covid_excess_death_ratio <= 10 ~ "[0,10]",
#   covid_excess_death_ratio > 10 & covid_excess_death_ratio <= 20 ~ "(10,20]",
#   covid_excess_death_ratio > 20 & covid_excess_death_ratio <= 30 ~ "(20,30]",
#   covid_excess_death_ratio > 30 & covid_excess_death_ratio <= 40 ~ "(30,40]",
#   covid_excess_death_ratio > 40 & covid_excess_death_ratio <= 50 ~ "(40,50]",
#   covid_excess_death_ratio > 50 & covid_excess_death_ratio <= 60 ~ "(50,60]",
#   covid_excess_death_ratio > 60 & covid_excess_death_ratio <= 70 ~ "(60,70]",
#   covid_excess_death_ratio > 70 & covid_excess_death_ratio <= 80 ~ "(70,80]",
#   covid_excess_death_ratio > 80 & covid_excess_death_ratio <= 90 ~ "(80,90]",
#   covid_excess_death_ratio > 90 & covid_excess_death_ratio <= 100 ~ "(90,100]"
# )
)
covid_excess_ratio_cum <- covid_excess_ratio %>%
group_by(covid_excess_death_ratio_cat) %>%
summarise(
n = n(),
pop = sum(cens_pop_est)
) %>%
# mutate(
#   covid_excess_death_ratio_cat = factor(
#     covid_excess_death_ratio_cat,
#     levels = c(
#       "[0,10]", "(10,20]", "(20,30]", "(30,40]", "(40,50]", "(50,60]",
#       "(60,70]", "(70,80]", "(80,90]", "(90,100]"
#     )
#   )
# ) %>%
arrange(covid_excess_death_ratio_cat) %>%
mutate(cum_pop = cumsum(pop))
kt <- kbl(covid_excess_ratio_cum, "latex",
booktabs = T, linesep = "",
col.names = c(
"Percent of excess deaths \n assigned to COVID-19",
"Number of county sets",
"Population",
"Cumulative population"
),
format.args = list(big.mark = ","),
row.names = TRUE
)
save_kable(kt, file = paste0(outpath, "atab_a2_covid_excess_ratio_pop.tex"), keep_tex = TRUE)
## make appendix Table C1: summary stat for each county set
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
source("prelim_plot.R")
## load data ----
dat_xc <- read_csv(paste0(datapath, "fitted_and_actual_deaths_county_sets_2020_W2020_wash_6_3.csv"))
tab_c1 <- dat_xc %>%
mutate(
excess_deaths_lwr_ci = all_cause_deaths_2020 - pred_deaths_upr_ci_2020,
excess_deaths_upr_ci = all_cause_deaths_2020 - pred_deaths_lwr_ci_2020,
cs_name = ifelse(cens_pop_est == 220164, "Doña Ana", cs_name),
cs_name = str_replace_all(cs_name, "\\+", "-")
) %>%
transmute(
county = paste0(cs_name, ", ", state),
expected_deaths_2020 = round(fitted_deaths_2020, 0),
expected_deaths_ci_2020 = paste0("(", round(pred_deaths_lwr_ci_2020, 0), ",", round(pred_deaths_upr_ci_2020, 0), ")"),
all_cause_deaths_2020 = round(all_cause_deaths_2020, 0),
obs_exp_ratio = round(all_cause_deaths_2020 / expected_deaths_2020, 2),
excess_deaths_2020 = round(excess_deaths_2020, 0),
excess_deaths_ci_2020 = paste0("(", round(excess_deaths_lwr_ci, 0), ",", round(excess_deaths_upr_ci, 0), ")"),
excess_death_rate_2020 = round(excess_death_rate_2020 * 100, 0),
covid_deaths_2020,
covid_excess_ratio = round(covid_deaths_2020 / excess_deaths_2020 * 100, 1),
covid_excess_ratio = ifelse(
covid_excess_ratio < 0 | is.infinite(covid_excess_ratio), NA, covid_excess_ratio
)
)
tab_c1 <- as.data.frame(tab_c1)
kt <- kable(tab_c1,
"latex",
booktabs = T, longtable = TRUE, linesep = "",
row.names = FALSE
) %>%
column_spec(1, width = "7em")
kt <- gsub(".*midrule", "", kt)
kt <- gsub("bottomrule.*$", "", kt)
save_kable(kt, file = paste0(outpath, "atab_c1_county_estimate_input.tex"), keep_tex = TRUE)
write_csv(tab_c1, "../output/tabc1_county_set_estimate.csv")
tab_c1 <- tab_c1 %>% arrange(covid_deaths_2020)
View(tab_c1)
## make appendix tab A2: cumulative pop in diff levels of excess death assignmnent to COVID-19
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
source("prelim_plot.R")
dat_xc <- read_csv(paste0(datapath, "fitted_and_actual_deaths_county_sets_2020_W2020_wash_6_3.csv"))
covid_excess_ratio <- dat_xc %>%
transmute(
county = cs_name, cens_pop_est,
covid_excess_death_ratio = (covid_deaths_2020 / excess_deaths_2020) * 100,
covid_excess_death_ratio = ifelse(
excess_deaths_2020 < 0, 0, ifelse(
covid_excess_death_ratio > 100, 100, covid_excess_death_ratio
)
),
covid_excess_death_ratio_cat = cut(covid_excess_death_ratio, breaks = seq(0, 100, 5), include.lowest = TRUE)
)
covid_excess_ratio_cum <- covid_excess_ratio %>%
group_by(covid_excess_death_ratio_cat) %>%
summarise(
n = n(),
pop = sum(cens_pop_est)
) %>%
arrange(covid_excess_death_ratio_cat) %>%
mutate(cum_pop = cumsum(pop))
kt <- kbl(covid_excess_ratio_cum, "latex",
booktabs = T, linesep = "",
col.names = c(
"Percent of excess deaths \n assigned to COVID-19",
"Number of county sets",
"Population",
"Cumulative population"
),
format.args = list(big.mark = ","),
row.names = TRUE
)
save_kable(kt, file = paste0(outpath, "atab_a2_covid_excess_ratio_pop.tex"), keep_tex = TRUE)
write_csv(covid_excess_ratio_cum, "../output/atab_a2_covid_excess_ratio_cumpop.csv")
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
source("prelim_plot.R")
dat_xc <- read_csv(paste0(datapath, "fitted_and_actual_deaths_county_sets_2020_W2020_wash_6_3.csv"))
a = dat_xc %>% filter(covid_deaths_2020 <= 0)
covid_excess_ratio <- dat_xc %>%
transmute(
county = cs_name, cens_pop_est,
covid_excess_death_ratio = (covid_deaths_2020 / excess_deaths_2020) * 100,
covid_excess_death_ratio = ifelse(
excess_deaths_2020 < 0, NA, ifelse(
covid_excess_death_ratio > 100, 100, covid_excess_death_ratio
)
),
covid_excess_death_ratio_cat = cut(covid_excess_death_ratio, breaks = seq(0, 100, 5), include.lowest = TRUE)
)
covid_excess_ratio <- covid_excess_ratio %>% arrange(covid_excess_death_ratio)
View(covid_excess_ratio)
a  = dat_xc %>% filter(excess_deaths_2020 < 0)
View(a)
## make appendix tab A2: cumulative pop in diff levels of excess death assignmnent to COVID-19
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
source("prelim_plot.R")
dat_xc <- read_csv(paste0(datapath, "fitted_and_actual_deaths_county_sets_2020_W2020_wash_6_3.csv"))
covid_excess_ratio <- dat_xc %>%
transmute(
county = cs_name, cens_pop_est,
covid_excess_death_ratio = (covid_deaths_2020 / excess_deaths_2020) * 100,
covid_excess_death_ratio = ifelse(
excess_deaths_2020 < 0, 100, ifelse(
covid_excess_death_ratio > 100, 100, covid_excess_death_ratio
)
),
covid_excess_death_ratio_cat = cut(covid_excess_death_ratio, breaks = seq(0, 100, 5), include.lowest = TRUE)
)
covid_excess_ratio_cum <- covid_excess_ratio %>%
group_by(covid_excess_death_ratio_cat) %>%
summarise(
n = n(),
pop = sum(cens_pop_est)
) %>%
arrange(covid_excess_death_ratio_cat) %>%
mutate(cum_pop = cumsum(pop))
kt <- kbl(covid_excess_ratio_cum, "latex",
booktabs = T, linesep = "",
col.names = c(
"Percent of excess deaths \n assigned to COVID-19",
"Number of county sets",
"Population",
"Cumulative population"
),
format.args = list(big.mark = ","),
row.names = TRUE
)
save_kable(kt, file = paste0(outpath, "atab_a2_covid_excess_ratio_pop.tex"), keep_tex = TRUE)
write_csv(covid_excess_ratio_cum, "../output/atab_a2_covid_excess_ratio_pop.csv")
